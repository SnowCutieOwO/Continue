import{_ as i,c as e,o as a,b0 as t}from"./chunks/framework.w6NQj85O.js";const d=JSON.parse('{"title":"存储系统故障","description":"","frontmatter":{},"headers":[],"relativePath":"LuckPerms/how-to.fix-storage-errors.md","filePath":"LuckPerms/how-to.fix-storage-errors.md"}'),l={name:"LuckPerms/how-to.fix-storage-errors.md"};function n(o,s,p,r,c,h){return a(),e("div",null,s[0]||(s[0]=[t(`<h1 id="存储系统故障" tabindex="-1">存储系统故障 <a class="header-anchor" href="#存储系统故障" aria-label="Permalink to &quot;存储系统故障&quot;">​</a></h1><p>本章节为<a href="./faq.html">常见问题</a>的拓展阅读，主要讲述了存储有关的问题与错误。</p><p>本章节包含了一些对不同形式存储方式（大部分是 MySQL）的常见问题与解决方法。</p><p>首先，让我们厘清 LuckPerms 对存储权限操作的相关内容。我们经常收到许多（有些时候挺恼人！）的用户评论，说插件不工作，有 95% 的情况都与 LuckPerms 无关。😢</p><p>为了让权限数据写入存储后端，LuckPerms 使用了一种称之为“驱动”的东西来来与底层的存储系统进行交互。</p><p>这些驱动是第三方制作的。它们已有大量的测试，且（大多数情况下）通过数据库的维护团队发布。</p><p>需要注意的是：</p><ul><li><strong>若错误源于驱动 - 这<em>不是</em> LuckPerms 导致的。</strong></li><li>你<em>可能</em>经历过驱动本身的错误，不过大部分情况下应该不会。</li><li>造成这些错误的一般原因是安装时配置不正确。</li></ul><p>下文是一些常见错误。如果你遇到的问题在这里无法找到，那么可以在 Github 上提交一个漏洞报告，我们可以为你指出正确的方向（或在它真的是 LuckPerms 的漏洞时修复它！）</p><h2 id="常见问题" tabindex="-1">常见问题 <a class="header-anchor" href="#常见问题" aria-label="Permalink to &quot;常见问题&quot;">​</a></h2><h3 id="luckperms-不能连接至-mysql-服务器" tabindex="-1">LuckPerms 不能连接至 MySQL 服务器 <a class="header-anchor" href="#luckperms-不能连接至-mysql-服务器" aria-label="Permalink to &quot;LuckPerms 不能连接至 MySQL 服务器&quot;">​</a></h3><p>诸如此类的报错：</p><blockquote><p>Caused by: java.util.concurrent.CompletionException: java.sql.SQLTransientConnectionException: luckperms - Connection is not available, request timed out after 5000ms. ... Caused by: java.sql.SQLTransientConnectionException: luckperms - Connection is not available, request timed out after 5000ms.</p></blockquote><blockquote><p>luckperms - Failed to validate connection com.mysql.jdbc.JDBC4Connection@xxxxxxxxx (Communications link failure) The last packet successfully received from the server was xxxxxxx milliseconds ago. The last packet sent successfully to the server was xx milliseconds ago.)</p></blockquote><p>请确认：</p><ul><li>你使用了正确的地址与端口号</li><li>你使用了正确的用户名/密码</li><li>数据库存在且当前用户可访问</li><li>服务器在线 &amp; 接受连接</li><li>无防火墙规则阻止连接</li><li>MySQL 绑定至正确的端口，且可在 LuckPerms 安装后从服务器访问</li><li>检查你的 MySQL 是否已到达最大连接数量。默认情况下，LuckPerms 每个服务器会提供 10 个连接。若你有其他插件连接至相同的服务器，你可能需要考虑提升该限制。</li></ul><p>若你遇到了 <code>Communications link failure</code> 错误，或者与超时有关的报错，那么上述列表中的某一个出现了问题。</p><p>若要让当前用户获得访问 LuckPerms 数据库表的权限，请执行如下指令：</p><div class="language-SQL vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">SQL</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">GRANT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ALL PRIVILEGES </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [数据库名称].</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> TO</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;[用户名称]&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;[IP 地址]&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div><p><input type="checkbox" id="checkbox0"><label for="checkbox0">中的内容进行相应替换后再执行即可。</label></p><p>如：</p><div class="language-SQL vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">SQL</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">GRANT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ALL PRIVILEGES </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> luckperms.</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> TO</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;luck&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;%&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div><p>之后，在完成你的操作后，执行命令：</p><div class="language-SQL vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">SQL</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">FLUSH PRIVILEGES;</span></span></code></pre></div><h2 id="mysql-ssl-错误" tabindex="-1">MySQL SSL 错误 <a class="header-anchor" href="#mysql-ssl-错误" aria-label="Permalink to &quot;MySQL SSL 错误&quot;">​</a></h2><p>若你得到的报错与下文相似：</p><blockquote><p>Establishing SSL connection without server&#39;s identity verification is not recommended. According to MySQL requirements SSL connection must be established by default if explicit option isn&#39;t set. For compliance with existing applications not using SSL the verifyServerCertificate property is set to &#39;false&#39;. You need either to explicitly disable SSL by setting useSSL=false, or set useSSL=true and provide truststore for server certificate verification.</p></blockquote><p>... 你需要为 MySQL 连接禁用 SSL。</p><p>你可以编辑 LuckPerms 的配置文件，在“Storage”部分中，找到如下部分的配置并进行编辑即可：</p><div class="language-YAML vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">YAML</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  pool-settings</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # This setting allows you to define extra properties for connections.</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    properties</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      useUnicode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      characterEncoding</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">utf8</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      useSSL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      verifyServerCertificate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span></span></code></pre></div><p>将文中的最后两项加入即可。</p><h2 id="mysql-no-operations-allowed-after-connection-closed-错误" tabindex="-1">MySQL“No operations allowed after connection closed”错误 <a class="header-anchor" href="#mysql-no-operations-allowed-after-connection-closed-错误" aria-label="Permalink to &quot;MySQL“No operations allowed after connection closed”错误&quot;">​</a></h2><p>若你得到的报错与下文相似：</p><blockquote><p>me.lucko.luckperms.lib.hikari.pool.PoolBase - luckperms-hikari - Failed to validate connection me.lucko.luckperms.lib.mysql.jdbc.JDBC4Connection@xxxxxxx (No operations allowed after connection closed.)</p></blockquote><blockquote><p>me.lucko.luckperms.lib.hikari.pool.PoolBase - luckperms-hikari- Failed to validate connection me.lucko.luckperms.lib.mariadb.MariaDbConnection@xxxxxxx (xxx cannot be called on a closed connection)</p></blockquote><p>...你需要修改（LP 配置中）<code>maxium-lifetime</code> 与 <code>wait-timeout</code>（MySQL 配置）设置。</p><p>需要注意的是，LP 配置文件中的 <code>maxium-lifetime</code> 值必须<strong>小于</strong> MySQL 配置中的 <code>wait_timeout</code> 值。</p><table tabindex="0"><thead><tr><th></th><th><code>maxium-lifetime</code></th><th><code>wait_timeout</code></th></tr></thead><tbody><tr><td>所处部分：</td><td><a href="https://github.com/LuckPerms/LuckPerms/blob/be92a6754404b387dead24ebc1dd3ca8af8e6456/bukkit/src/main/resources/config.yml#L125-L128" target="_blank" rel="noreferrer">LuckPerms 配置文件</a></td><td><a href="https://dev.mysql.com/doc/refman/5.7/en/server-system-variables.html#sysvar_wait_timeout" target="_blank" rel="noreferrer">MySQL 服务器配置</a></td></tr><tr><td>单位：</td><td>毫秒</td><td>秒</td></tr><tr><td>默认值：</td><td><code>1800000</code>（30 分钟）</td><td><code>28800</code>（8 小时）</td></tr></tbody></table><p>只要 <code>maxium-lifetime</code> 小于 <code>wait_timeout</code>，不论改哪个值都无伤大雅。别忘了这俩单位不一样！</p><p>默认的 <code>maxium-lifetime</code> 为 30 分钟，对<strong>大部分</strong>用户都适用。一般情况下如果服务器提供商修改了默认 8 小时的等待时间（后者）时才会出现问题。</p><p>若你的 MySQL 服务器是由第三方提供的，可以问问看他们关于该值的设置。</p><h2 id="mysql-达到了最大连接数" tabindex="-1">MySQL 达到了最大连接数 <a class="header-anchor" href="#mysql-达到了最大连接数" aria-label="Permalink to &quot;MySQL 达到了最大连接数&quot;">​</a></h2><p>若你得到的报错与下文相似：</p><blockquote><p>Caused by: com.mysql.jdbc.exceptions.jdbc4.MySQLSyntaxErrorException: User &#39;xxxxxxxxx&#39; has exceeded the &#39;max_user_connections&#39; resource (current value: xxx)</p></blockquote><p>你的 MySQL 当前用户已达到最大连接数量。默认情况下，LuckPerms 会为每个服务器提供 10 个连接。若你有其他插件连接至相同的服务器，你可能需要考虑提升该限制。</p><p>若你正在运行自己的 MySQL 服务器，这里有些链接讲到了如何提升这个限制的教程。</p><ul><li><a href="https://dev.mysql.com/doc/refman/5.5/en/too-many-connections.html" target="_blank" rel="noreferrer">https://dev.mysql.com/doc/refman/5.5/en/too-many-connections.html</a></li><li><a href="https://www.electrictoolbox.com/update-max-connections-mysql/" target="_blank" rel="noreferrer">https://www.electrictoolbox.com/update-max-connections-mysql/</a></li></ul><p>若你的 MySQL 服务器由服务器提供商负责，你需要联系他们来进行相关修改。</p><h2 id="mysql-公钥返回不被允许" tabindex="-1">MySQL 公钥返回不被允许 <a class="header-anchor" href="#mysql-公钥返回不被允许" aria-label="Permalink to &quot;MySQL 公钥返回不被允许&quot;">​</a></h2><p>若你得到的报错与下文相似：</p><blockquote><p>Caused by: me.lucko.luckperms.lib.mysql.jdbc.exceptions.jdbc4.MySQLNonTransientConnectionException: Public Key Retrieval is not allowed</p></blockquote><p>这是一个可以改正的 MySQL 问题。</p><p>你可以编辑 LuckPerms 的配置文件，在“Storage”部分中，找到如下部分的配置并进行编辑即可：</p><div class="language-YAML vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">YAML</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  pool-settings</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # This setting allows you to define extra properties for connections.</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    properties</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      useUnicode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      characterEncoding</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">utf8</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      useSSL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      verifyServerCertificate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      allowPublicKeyRetrieval</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span></code></pre></div><p>在最后一行，加上 <code>allowPublicKeyRetrieval</code>，并将其设置为 true。</p><h2 id="mysql-设置端口失败" tabindex="-1">MySQL 设置端口失败 <a class="header-anchor" href="#mysql-设置端口失败" aria-label="Permalink to &quot;MySQL 设置端口失败&quot;">​</a></h2><p>若你得到的报错与下文相似：</p><blockquote><p>Failed to set property port on target class me.lucko.luckperms.lib.mysql.jdbc.jdbc2.optional.MysqlDataSource java.lang.NumberFormatException: For input string: xxxx</p></blockquote><p>你在 LuckPerms 中 <code>address</code> 的设置不能建立端口，大部分情况下是地址与端口不正确。若端口为 3306，因为它是默认端口，所以无需设置。正确的 <code>address</code> 格式为<code>&quot;地址:端口号&quot;</code>。</p><h2 id="luckperms-无法连接至-redis-服务器" tabindex="-1">LuckPerms 无法连接至 Redis 服务器 <a class="header-anchor" href="#luckperms-无法连接至-redis-服务器" aria-label="Permalink to &quot;LuckPerms 无法连接至 Redis 服务器&quot;">​</a></h2><p>请确认：</p><ul><li>你使用了正确的地址与端口号</li><li>你输入的密码正确</li><li>无防火墙规则阻止连接</li><li>Redis 服务器正常启动</li></ul>`,62)]))}const u=i(l,[["render",n]]);export{d as __pageData,u as default};
